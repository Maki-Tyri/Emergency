<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase File Manager with Delete</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 10px;
      background: #e7f5fe;
      color: #1f4037;
    }
    h1 {
      text-align: center;
      color: #14532d;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #1f4037;
      color: white;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #14532d;
    }
    .folder, .file {
      background: white;
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .folder > strong {
      font-size: 1.1rem;
    }
    .files {
      margin-top: 8px;
      padding-left: 15px;
    }
    .files div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 4px 0;
    }
    a.file-link {
      color: #14532d;
      text-decoration: none;
      cursor: pointer;
      max-width: 80%;
      overflow-wrap: break-word;
    }
    a.file-link:hover {
      text-decoration: underline;
    }
    .delete-btn {
      background: transparent;
      border: none;
      color: #c92a2a;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0 6px;
      transition: color 0.2s ease;
    }
    .delete-btn:hover {
      color: #820000;
    }
    #uploadSection {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    #progressBar {
      width: 100%;
      height: 20px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>Firebase File Manager</h1>

  <section id="createFolderSection">
    <input type="text" id="folderNameInput" placeholder="New folder name" />
    <button id="createFolderBtn">Create Folder</button>
  </section>

  <section id="uploadSection">
    <select id="folderSelect">
      <option value="" disabled selected>Select folder to upload</option>
    </select><br/>
    <input type="file" id="fileInput" />
    <button id="uploadBtn">Upload File</button>
    <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
  </section>

  <section id="foldersList"></section>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Elements
    const folderNameInput = document.getElementById("folderNameInput");
    const createFolderBtn = document.getElementById("createFolderBtn");
    const folderSelect = document.getElementById("folderSelect");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressBar = document.getElementById("progressBar");
    const foldersList = document.getElementById("foldersList");

    // Create Folder
    createFolderBtn.onclick = () => {
      const folderName = folderNameInput.value.trim();
      if (!folderName) {
        alert("Please enter a folder name");
        return;
      }
      // Save folder in Realtime DB
      database.ref('folders/' + folderName).set(true)
        .then(() => {
          folderNameInput.value = "";
          alert("Folder created: " + folderName);
          listFolders();
        })
        .catch(err => alert("Error creating folder: " + err.message));
    };

    // Upload File
    uploadBtn.onclick = () => {
      const folderName = folderSelect.value;
      const file = fileInput.files[0];
      if (!folderName) {
        alert("Please select a folder first");
        return;
      }
      if (!file) {
        alert("Please select a file to upload");
        return;
      }
      uploadBtn.disabled = true;
      progressBar.style.display = "block";
      progressBar.value = 0;

      const storageRef = storage.ref(folderName + "/" + file.name);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.value = progress;
        }, 
        error => {
          alert("Upload failed: " + error.message);
          uploadBtn.disabled = false;
          progressBar.style.display = "none";
        }, 
        () => {
          alert("File uploaded!");
          fileInput.value = "";
          uploadBtn.disabled = false;
          progressBar.style.display = "none";
          listFiles(folderName);
        });
    };

    // List folders
    function listFolders() {
      folderSelect.innerHTML = '<option value="" disabled selected>Select folder to upload</option>';
      foldersList.innerHTML = "";
      database.ref('folders').once('value').then(snapshot => {
        const folders = snapshot.val();
        if (!folders) {
          folderSelect.innerHTML += '<option disabled>No folders yet</option>';
          foldersList.innerHTML = "<em>No folders yet.</em>";
          return;
        }
        Object.keys(folders).forEach(folder => {
          // Add to select
          const option = document.createElement("option");
          option.value = folder;
          option.textContent = folder;
          folderSelect.appendChild(option);

          // Show folder with delete button
          const folderDiv = document.createElement("div");
          folderDiv.className = "folder";
          folderDiv.innerHTML = `
            <strong>${folder}</strong>
            <button class="delete-btn" onclick="deleteFolder('${folder}')">Delete Folder</button>
            <div id="files-${folder}" class="files"><em>Loading files...</em></div>
          `;
          foldersList.appendChild(folderDiv);

          // List files inside this folder
          listFiles(folder);
        });
      });
    }

    // List files in folder
    function listFiles(folder) {
      const filesDiv = document.getElementById(`files-${folder}`);
      filesDiv.innerHTML = ""; // clear previous

      storage.ref(folder).listAll()
        .then(res => {
          if (res.items.length === 0) {
            filesDiv.innerHTML = "<em>No files yet.</em>";
            return;
          }
          res.items.forEach(itemRef => {
            const fileName = itemRef.name;

            const fileLink = document.createElement("a");
            fileLink.textContent = fileName;
            fileLink.href = "#";
            fileLink.className = "file-link";
            fileLink.onclick = (e) => {
              e.preventDefault();
              itemRef.getDownloadURL().then(url => {
                window.open(url, "_blank");
              });
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => deleteFile(folder, fileName);

            const fileItem = document.createElement("div");
            fileItem.className = "file";
            fileItem.appendChild(fileLink);
            fileItem.appendChild(deleteBtn);

            filesDiv.appendChild(fileItem);
          });
        })
        .catch(() => {
          filesDiv.innerHTML = "<em>Error loading files.</em>";
        });
    }

    // Delete folder and all files inside
    function deleteFolder(folderName) {
      if (!confirm(`Delete folder "${folderName}" and ALL its files? This action CANNOT be undone.`)) return;

      const folderRef = storage.ref(folderName);
      folderRef.listAll()
        .then(res => {
          const deletePromises = res.items.map(itemRef => itemRef.delete());
          return Promise.all(deletePromises);
        })
        .then(() => database.ref('folders/' + folderName).remove())
        .then(() => {
          alert(`Folder "${folderName}" and all files deleted.`);
          listFolders();
        })
        .catch(err => alert("Error deleting folder: " + err.message));
    }

    // Delete single file
    function deleteFile(folderName, fileName) {
      if (!confirm(`Delete file "${fileName}" from folder "${folderName}"?`)) return;

      storage.ref(folderName + "/" + fileName).delete()
        .then(() => {
          alert(`File "${fileName}" deleted.`);
          listFiles(folderName);
        })
        .catch(err => alert("Error deleting file: " + err.message));
    }

    window.onload = listFolders;
  </script>
</body>
</html>
