<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency App</title>
  <style>
    video { width: 100%; max-height: 300px; border: 2px solid red; }
    body { font-family: sans-serif; padding: 1em; }
  </style>
</head>
<body>
  <h1>ğŸš¨ Emergency Activated</h1>
  <p>Camera, mic, location, and SMS alert running...</p>
  <video autoplay muted></video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX",
      databaseURL: "https://project-955237504610034331-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const functions = getFunctions(app);

    const contactID = "emergency_contact_001";
    const toPhone = "+639859396534"; // ğŸ“± Replace with actual emergency contact

    const videoEl = document.querySelector("video");
    let recorder;
    let chunks = [];

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      videoEl.srcObject = stream;

      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        console.log("ğŸ¥ Recording complete:", blob.size);
        // Upload video to Firebase Storage if needed
      };
      recorder.start();

      setTimeout(() => recorder.stop(), 30000); // Record 30s
    });

    function sendSMSAlert(lat, lng) {
      const sendSMS = httpsCallable(functions, "sendEmergencySMS");
      sendSMS({
        contactID,
        lat,
        lng,
        to: toPhone
      })
      .then(() => console.log("âœ… SMS alert sent"))
      .catch(err => console.error("âŒ SMS send error:", err));
    }

    function updateLocation(lat, lng) {
      const data = { lat, lng, timestamp: Date.now() };
      set(ref(db, `emergency_contacts/${contactID}/location`), data);
      sendSMSAlert(lat, lng);
    }

    navigator.geolocation.getCurrentPosition(
      pos => updateLocation(pos.coords.latitude, pos.coords.longitude),
      err => console.error("âŒ Location error:", err),
      { enableHighAccuracy: true }
    );
  </script>
</body>
</html>
