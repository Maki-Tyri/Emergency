<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency App</title>
  <style>
    video { width: 100%; max-height: 300px; border: 2px solid red; }
    body { font-family: sans-serif; padding: 1em; }
  </style>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX",
      databaseURL: "https://project-955237504610034331-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // You can customize this contact ID per user/session
    const contactID = "emergency_contact_001";

    // Auto start video + audio
    const videoEl = document.createElement("video");
    videoEl.autoplay = true;
    videoEl.muted = true;
    document.body.appendChild(videoEl);

    let recorder;
    let chunks = [];

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      videoEl.srcObject = stream;

      // Auto record
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        // Uploading to Firebase Storage or save locally can be added here
        console.log("Recording stopped, size:", blob.size);
      };
      recorder.start();

      // Stop recording after 30 seconds
      setTimeout(() => recorder.stop(), 30000);
    });

    // Location + Realtime DB + Email alert
    function sendEmailAlert(lat, lng) {
      const templateParams = {
        contact_id: contactID,
        latitude: lat,
        longitude: lng,
        map_link: `https://maps.google.com/?q=${lat},${lng}`
      };

      emailjs.send("service_y3dgack", "template_ii39kfq", templateParams)
        .then(() => console.log("✅ Email alert sent"))
        .catch(error => console.error("❌ Email send error:", error));
    }

    function updateLocation(lat, lng) {
      const data = {
        lat,
        lng,
        timestamp: Date.now()
      };
      set(ref(db, `emergency_contacts/${contactID}/location`), data);
      sendEmailAlert(lat, lng);
    }

    navigator.geolocation.getCurrentPosition(
      pos => updateLocation(pos.coords.latitude, pos.coords.longitude),
      err => console.error("Location error:", err),
      { enableHighAccuracy: true }
    );
  </script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("EfJgSHkCSxpwLzbGu"); // ✅ Your Public Key
  </script>
</head>
<body>
  <h1>🚨 Emergency Activated</h1>
  <p>Camera, mic, location, and alert system running...</p>
</body>
</html>
