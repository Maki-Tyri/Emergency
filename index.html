<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency Auto Recorder</title>
</head>
<body>
  <h2>Set Emergency Contact</h2>
  <input type="text" id="contactId" placeholder="Enter contact ID (e.g. user123)" />
  <button onclick="saveContact()">Save Contact</button>

  <h3 id="status">Waiting for contact...</h3>
  <video id="preview" autoplay playsinline muted></video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const video = document.getElementById('preview');
    const statusEl = document.getElementById('status');
    const contactInput = document.getElementById('contactId');

    let mediaRecorder;
    let chunks = [];

    // Save contact to localStorage
    window.saveContact = function() {
      const contact = contactInput.value.trim();
      if (contact) {
        localStorage.setItem("emergency_contact", contact);
        statusEl.textContent = "Contact saved. Starting emergency functions...";
        startEmergencyFlow(contact);
      }
    }

    // Send location to Firebase
    function sendLocation(contact) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const data = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            timestamp: Date.now()
          };
          const locRef = ref(db, `emergency_contacts/${contact}/location`);
          set(locRef, data);
        });
      }
    }

    // Start camera/mic and recording
    async function startEmergencyFlow(contact) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const fileRef = sRef(storage, `emergency_contacts/${contact}/video_${Date.now()}.webm`);
          await uploadBytes(fileRef, blob);
          statusEl.textContent = "Recording uploaded to Firebase.";
        };

        mediaRecorder.start();
        statusEl.textContent = "Recording started. Sending location...";

        sendLocation(contact);

        // Stop after 10 sec for demo
        setTimeout(() => {
          mediaRecorder.stop();
        }, 10000);

      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error: " + e.message;
      }
    }

    // Auto-start if contact already set
    window.onload = () => {
      const savedContact = localStorage.getItem("emergency_contact");
      if (savedContact) {
        contactInput.value = savedContact;
        statusEl.textContent = "Contact found. Starting emergency functions...";
        startEmergencyFlow(savedContact);
      }
    };
  </script>
</body>
</html>
